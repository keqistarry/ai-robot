# 小哈 AI 机器人 - 后端项目描述

## 项目描述

基于 Spring AI 框架开发的智能对话系统后端服务，支持普通 AI 对话、联网搜索增强对话和 RAG 智能客服三种模式。通过 Advisor 机制实现对话记忆、联网搜索、向量检索等能力的灵活组合，采用 SSE 流式输出提升用户体验。实现了完整的知识库管理功能，支持 Markdown 文件分片上传、向量化存储和智能检索。

## 技术栈

**核心框架**：Spring Boot 3.4.5 + Spring AI 1.1.1 + JDK 21

**AI 能力**：OpenAI Compatible API（阿里云百炼）+ Text Embedding V4

**数据存储**：PostgreSQL + pgvector（向量存储）+ MyBatis-Plus

**联网搜索**：SearXNG + OkHttp + Jsoup

**其他技术**：SSE 流式输出、Spring Event 异步事件、AOP 日志、HikariCP 连接池

## 核心功能点

### 1. 普通 AI 对话（带记忆）
- 实现流式 SSE 对话输出，支持动态切换模型和温度参数
- 通过 [`CustomChatMemoryAdvisor`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/advisor/CustomChatMemoryAdvisor.java) 实现对话记忆（最近 50 条消息）
- 使用 [`CustomStreamLoggerAndMessage2DBAdvisor`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/advisor/CustomStreamLoggerAndMessage2DBAdvisor.java) 实现流式日志打印和消息实时落库
- 支持对话历史查询、重命名、删除等管理功能

### 2. 联网搜索增强对话
- 集成 SearXNG 搜索引擎，通过 [`NetworkSearchAdvisor`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/advisor/NetworkSearchAdvisor.java) 实现联网搜索增强
- 并发抓取搜索结果页面内容（7 秒超时），使用 Jsoup 解析网页正文
- 构建包含来源链接和相关性评分的上下文，通过 PromptTemplate 重组增强提示词
- 回答中自动标注来源链接，支持跳转验证

### 3. RAG 智能客服
- 实现 Markdown 知识库文件的分片上传（支持断点续传和秒传）
- 通过 [`AiCustomerServiceMdUploadedListener`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/event/listener/AiCustomerServiceMdUploadedListener.java) 异步监听文件上传事件，自动触发向量化处理
- 使用 [`MarkdownReader`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/reader/MarkdownReader.java) 解析 Markdown 文档，分段向量化存储到 pgvector
- 通过 [`CustomerServiceAdvisor`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/advisor/CustomerServiceAdvisor.java) 实现向量检索增强（topK=3），基于相似度召回相关文档
- 向量化时自动去重（相似度 > 0.99 跳过），避免重复数据

### 4. 技术亮点
- **Advisor 链式调用**：通过 Spring AI 的 Advisor 机制实现对话增强能力的模块化和可组合性
- **流式输出优化**：SSE 流式返回 AI 回答，边生成边落库，提升响应速度
- **异步事件驱动**：使用 Spring Event + 自定义线程池处理文件向量化，避免阻塞主线程
- **分片上传机制**：支持大文件分片上传、MD5 校验、断点续传和秒传功能
- **向量检索优化**：使用 pgvector 的 HNSW 索引 + COSINE 距离，提升检索性能
- **编程式事务**：向量化过程使用 TransactionTemplate 确保数据一致性
- **SQL 监控**：集成 p6spy 实时监控 SQL 执行，便于性能调优

## 工作内容

### 架构设计
- 设计基于 Advisor 模式的对话增强架构，实现记忆、联网、RAG 能力的灵活组合
- 设计分片上传 + 异步向量化的知识库处理流程，支持大文件高效处理
- 设计流式输出 + 实时落库的双写机制，保证数据完整性

### 核心开发
- 实现 [`ChatController`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/controller/ChatController.java) 和 [`AiCustomerServiceController`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/controller/AiCustomerServiceController.java) 两大核心接口
- 开发 4 个关键 Advisor：对话记忆、联网搜索、RAG 检索、流式日志落库
- 实现 [`CustomerServiceImpl`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/service/impl/CustomerServiceImpl.java) 知识库管理服务，包含文件上传、分片合并、向量化处理
- 开发 [`SearXNGService`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/service/SearXNGService.java) 和 [`SearchResultContentFetcherService`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/service/SearchResultContentFetcherService.java) 实现联网搜索和内容抓取

### 性能优化
- 使用 CompletableFuture 并发抓取搜索结果，设置合理超时时间
- 优化分片合并逻辑，使用 8KB 缓冲区分块读写，避免内存溢出
- 配置 HikariCP 连接池参数，优化数据库连接管理
- 向量化时实现去重逻辑，减少存储空间和检索时间

### 数据库设计
- 设计对话表（[`t_chat`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/domain/dos/ChatDO.java)）和消息表（[`t_chat_message`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/domain/dos/ChatMessageDO.java)）存储对话历史
- 设计文件存储表（[`t_ai_customer_service_file_storage`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/domain/dos/AiCustomerServiceFileStorageDO.java)）和分片信息表（[`t_file_chunk_info`](xiaoha-ai-robot-springboot/src/main/java/com/quanxiaoha/ai/robot/domain/dos/FileChunkInfoDO.java)）管理文件上传
- 使用 pgvector 扩展创建向量表（`t_vector_store`），配置 HNSW 索引

